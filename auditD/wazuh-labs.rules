## wazuh-labs.rules
## Ubuntu Server 24.04 - Web Service + Wazuh Agent
## Focus: Web compromise, privilege escalation, persistence, anti-tampering
## Notes:
## - Tune PATHs for your environment (web root / nginx/apache).
## - Uses -k keys for easy correlation in Wazuh/SIEM.

########################
## 0) Baseline / Tuning
########################
-D
-b 8192
-f 1
-i

########################
## 1) Self-auditing (anti-tamper)
########################
-w /var/log/audit/ -p wa -k auditlog
-w /etc/audit/ -p wa -k auditconfig
-w /etc/audisp/ -p wa -k auditconfig
-w /etc/libaudit.conf -p wa -k auditconfig

-w /sbin/auditctl -p x -k audittools
-w /sbin/auditd -p x -k audittools
-w /sbin/augenrules -p x -k audittools
-w /sbin/ausearch -p x -k audittools
-w /sbin/aureport -p x -k audittools
-w /usr/sbin/service -p x -k servicectl
-w /usr/bin/systemctl -p x -k servicectl

########################
## 2) Identity / Auth / Privilege config
########################
-w /etc/passwd -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/gshadow -p wa -k identity

-w /etc/sudoers -p wa -k sudo
-w /etc/sudoers.d/ -p wa -k sudo

-w /etc/pam.d/ -p wa -k pam
-w /etc/security/ -p wa -k pam

-w /etc/ssh/sshd_config -p wa -k sshd
-w /etc/ssh/sshd_config.d/ -p wa -k sshd
-w /root/.ssh/ -p wa -k sshkeys
-w /home/ -p wa -k userhome

########################
## 3) Web service focus (adjust paths as needed)
########################
## Common web roots (enable the ones you use)
-w /var/www/ -p wa -k webroot
-w /usr/share/nginx/ -p wa -k webroot

## Nginx / Apache configs (keep both if unsure)
-w /etc/nginx/ -p wa -k nginx
-w /etc/apache2/ -p wa -k apache

## Common app/service configs
-w /etc/php/ -p wa -k php
-w /etc/letsencrypt/ -p wa -k tls

########################
## 4) Web user execution (www-data uid=33 on Ubuntu/Debian)
########################
##-a always,exit -F arch=b64 -S execve -F uid=33 -F key=audit-wazuh-c
##-a always,exit -F arch=b32 -S execve -F uid=33 -F key=audit-wazuh-c

########################
## 5) Privilege escalation / risky syscalls
########################
## Privilege escalation / identity switching (valid syscalls)
-a always,exit -F arch=b64 -S setuid,setreuid,setresuid,setfsuid -k priv_esc
-a always,exit -F arch=b64 -S setgid,setregid,setresgid,setfsgid -k priv_esc
-a always,exit -F arch=b32 -S setuid,setreuid,setresuid,setfsuid -k priv_esc
-a always,exit -F arch=b32 -S setgid,setregid,setresgid,setfsgid -k priv_esc

## Track permission/ownership changes (often used for persistence)
-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -k perm_mod
-a always,exit -F arch=b64 -S chown,fchown,fchownat,lchown -k perm_mod
-a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -k perm_mod
-a always,exit -F arch=b32 -S chown,fchown,fchownat,lchown -k perm_mod

########################
## 6) Persistence: cron / systemd / init
########################
-w /etc/cron.d/ -p wa -k cron
-w /etc/crontab -p wa -k cron
-w /etc/cron.daily/ -p wa -k cron
-w /etc/cron.hourly/ -p wa -k cron
-w /etc/cron.weekly/ -p wa -k cron
-w /etc/cron.monthly/ -p wa -k cron
-w /var/spool/cron/ -p wa -k cron

-w /etc/systemd/system/ -p wa -k systemd
-w /lib/systemd/system/ -p wa -k systemd

## rc.local (if present/used)
-w /etc/rc.local -p wa -k persistence

########################
## 7) Network / Firewall changes
########################
-w /etc/hosts -p wa -k network
-w /etc/resolv.conf -p wa -k network
-w /etc/netplan/ -p wa -k network

-w /sbin/iptables -p x -k firewall
-w /usr/sbin/iptables -p x -k firewall
-w /sbin/ip6tables -p x -k firewall
-w /usr/sbin/ip6tables -p x -k firewall
-w /usr/sbin/nft -p x -k firewall

########################
## 8) Package management (post-exploitation)
########################
-w /usr/bin/apt -p x -k package
-w /usr/bin/apt-get -p x -k package
-w /usr/bin/apt-cache -p x -k package
-w /usr/bin/dpkg -p x -k package
-w /usr/bin/snap -p x -k package

########################
## 9) Kernel / modules (high impact)
########################
-w /sbin/insmod -p x -k kernelmod
-w /sbin/rmmod -p x -k kernelmod
-w /sbin/modprobe -p x -k kernelmod

########################
## 10) Anti-evasion / modern techniques
########################
## execveat can bypass simplistic execve-only detections
-a always,exit -F arch=b64 -S execveat -k execveat
-a always,exit -F arch=b32 -S execveat -k execveat

## fileless-ish behavior
-a always,exit -F arch=b64 -S memfd_create -k fileless

########################
## 11) Wazuh agent self-protection (optional but useful)
########################
-w /var/ossec/ -p wa -k wazuh
-w /etc/ossec-init.conf -p wa -k wazuh
-w /etc/ossec.conf -p wa -k wazuh

########################
## 12) Wazuh Monitoring execution Command by User
########################

# -------- root (AUID=0) --------
-a always,exit -F arch=b64 -S execve -F auid=0  -k audit-wazuh-c  
-a always,exit -F arch=b32 -S execve -F auid=0  -k audit-wazuh-c

# -------- www-data (UID=33) --------
# uid=33 catches processes actually running as www-data (e.g., apache/php)
-a always,exit -F arch=b64 -S execve -F auid=33 -k audit-wazuh-c
-a always,exit -F arch=b32 -S execve -F auid=33 -k audit-wazuh-c

# -------- normal users (AUID>=1000) --------
-a always,exit -F arch=b64 -S execve -F auid>=1000 -F auid!=-1 -k audit-wazuh-c
-a always,exit -F arch=b32 -S execve -F auid>=1000 -F auid!=-1 -k audit-wazuh-c

########################
## End
########################
# NOTE: Do NOT enable immutable (-e 2) until you're sure you won't need to change rules frequently.
# -e 2
